<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/ddgsubmark.svg') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editează Produse</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 30px;
          background-color: #fffaf9;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          table-layout: fixed; /* face coloanele egale și mai ordonate */
        }
        thead {
            position: sticky;
            top: 0;
            background-color: var(--roz-glazurat);
            z-index: 2;
            }

        
        th, td {
          border: 1px solid var(--caramel);
          padding: 8px 10px;
          vertical-align: top;
          text-align: center;
          font-size: 14px;
          word-wrap: break-word;
        }
        
        th {
          background-color: var(--roz-glazurat);
          font-family: 'Lato Bold', Arial, sans-serif;
          text-align: center;
        }
        
        td img {
          width: 50px;
          height: 50px;
          object-fit: cover;
          border-radius: 6px;
          display: block;
          margin: 0 auto;
        }
        
        /* Inputuri și textarea */
        input[type="text"],
        input[type="number"],
        textarea,
        select {
          width: 100%;
          padding: 6px 8px;
          border: 1px solid var(--caramel);
          border-radius: 6px;
          font-family: 'Lato', Arial, sans-serif;
          box-sizing: border-box;
          font-size: 14px;
          background: #fffdfd;
        }
        
        textarea {
            resize: none;
            overflow: hidden;
            line-height: 1.4;
            background: #fffdfd;
            min-height: 50px;
            max-height: none;
            }

        
        /* Butoane */
        button {
          padding: 6px 12px;
          background-color: var(--inghetata-capsuni);
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-family: 'Lato Bold', sans-serif;
          transition: background 0.2s ease;
        }
        
        button:hover {
          background-color: var(--miere);
        }
        
        .save-button {
          background-color: var(--ciocolata-neagra);
        }
        
        .save-button:hover {
          background-color: var(--caramel);
        }
        
        /* În modul editare: highlight subtil */
        tr.editing {
          background-color: #fff3f2;
          box-shadow: inset 0 0 4px rgba(0,0,0,0.05);
        }
        
        /* Imagine în edit-mode mai mică */
        .thumb-preview {
          width: 60px !important;
          height: 60px !important;
          margin-bottom: 5px;
        }
        
        /* Celula imaginii în edit-mode mai compactă */
        .image-cell {
          text-align: center;
        }
        
        .image-cell label {
          font-size: 13px;
          padding: 4px 8px;
        }
        textarea {
  resize: none;
  overflow: hidden;
  line-height: 1.4;
  min-height: 60px;
  max-height: 250px;
  background: #fffdfd;
}

tr.editing td {
  background: #fff7f6;
}

small {
  display: block;
  text-align: center;
}

        </style>
        
        
</head>
<body>
    <header>
        <h1>Panou Admin</h1>
        <nav>
            <ul>
                <li><a href="/admin">Adauga</a></li>
                <li><a href="/admin/edit-producs">Editeaza</a></li>
                <li><a href="/logout">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h2>Editează Produse</h2>
        <table id="products-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nume</th>
                    <th>Descriere</th>
                    <th>Preț</th>
                    <th>Imagine</th>
                    <th>Ingrediente</th>
                    <th>Alergeni</th>
                    <th>Categorie</th>
                    <th>Acțiuni</th>
                </tr>
            </thead>
            <tbody>
                {% for produs in produse %}
                <tr data-id="{{ produs['id'] }}">
                    <td>{{ produs['id'] }}</td>
                    <td class="view-mode">{{ produs['nume'] }}</td>
                    <td class="view-mode">{{ produs['descriere'] }}</td>
                    <td class="view-mode">{{ produs['pret'] }}</td>
                    <td class="view-mode">{{ produs['imagine'] }}</td>
                    <td class="view-mode">{{ produs['ingrediente'] }}</td>
                    <td class="cell-alergeni view-cell">{{ produs['alergeni'] or '' }}</td>
                    <td class="view-mode">
                        <select style="display: none;">
                            {% for category in categories %}
                            <option value="{{ category['categorie'] }}" {% if category['categorie'] == produs['categorie'] %}selected{% endif %}>
                                {{ category['categorie'] }}
                            </option>
                            {% endfor %}
                        </select>
                        <span>{{ produs['categorie'] }}</span>
                    </td>
                    <td>
                        <button class="edit-button">Editează</button>
                        <button class="save-button" style="display: none;">Salvează</button>
                    </td>
                </tr>
                
                {% endfor %}
            </tbody>
        </table>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === AUTO-RESIZE TEXTAREA ===
            function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
            }
            document.addEventListener('input', e => {
            if (e.target.tagName === 'TEXTAREA') autoResize(e.target);
            });

          const table = document.getElementById('products-table');
        
          table.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const row = btn.closest('tr');
            if (btn.classList.contains('edit-button')) enableEditMode(row);
            if (btn.classList.contains('save-button')) saveRow(row);
          });
        
          function enableEditMode(row) {
            // 🔹 Salvăm HTML-ul original ca să putem reveni exact la view.
            row.classList.add('editing');
            row.dataset.viewHtml = row.innerHTML;
        
            // coloane: 0 ID | 1 Nume | 2 Descriere | 3 Preț | 4 Imagine | 5 Ingrediente | 6 Categorie | 7 Acțiuni
            const imgCell = row.cells[4];
            const currentImg =
              imgCell.querySelector('img')?.getAttribute('src') ||
              imgCell.textContent.trim();
        
            row.dataset.currentImage = currentImg;
        
            row.cells[1].innerHTML = `<input type="text" name="nume" value="${row.cells[1].textContent.trim()}">`;
            row.cells[2].innerHTML = `<textarea name="descriere">${row.cells[2].textContent.trim()}</textarea>`;
            autoResize(row.querySelector('textarea[name="descriere"]'));
            row.cells[3].innerHTML = `<input type="number" step="0.01" name="pret" value="${row.cells[3].textContent.trim()}">`;
        
            imgCell.classList.add('image-cell');
imgCell.innerHTML = `
  <div style="display:flex;flex-direction:column;align-items:center;gap:6px;max-width:110px;margin:auto;">
    ${currentImg
      ? `<img class="thumb-preview" src="${currentImg}" alt="Previzualizare" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #ddd">`
      : `<div class="thumb-preview" style="width:80px;height:80px;border:1px dashed #ccc;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#777;font-size:12px;">Fără</div>`
    }
    <label style="background:#ec4e5d;color:#fff;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:13px;">
      Alege imagine
      <input type="file" name="imagine" accept="image/*" hidden>
    </label>
    <small style="font-size:12px;color:#7a4444;opacity:0.8;text-align:center;">Dacă nu alegi nimic,<br>rămâne imaginea actuală.</small>
  </div>
`;

            row.cells[5].innerHTML = `<textarea name="ingrediente">${row.cells[5].textContent.trim()}</textarea>`;
            autoResize(row.querySelector('textarea[name="ingrediente"]'));

            row.cells[6].innerHTML = `<textarea name="alergeni">${row.cells[6].textContent.trim()}</textarea>`;
            autoResize(row.querySelector('textarea[name="alergeni"]'));
        
            const select = row.cells[7].querySelector('select');
            const span = row.cells[7].querySelector('span');
            if (select && span) { select.style.display = 'inline-block'; span.style.display = 'none'; }
            else if (!select) { row.cells[7].innerHTML = `<input type="text" name="categorie" value="${row.cells[7].textContent.trim()}">`; }
        
            row.querySelector('.edit-button').style.display = 'none';
            row.querySelector('.save-button').style.display = 'inline-block';
          }

          document.addEventListener('input', e => {
            if (e.target.tagName.toLowerCase() === 'textarea') {
                e.target.style.height = 'auto';
                e.target.style.height = e.target.scrollHeight + 'px';
            }
            });

        
          async function saveRow(row) {
            const productId = row.dataset.id;
        
            const fd = new FormData();
            fd.append('nume', row.querySelector('input[name="nume"]').value);
            fd.append('descriere', row.querySelector('textarea[name="descriere"]').value);
            fd.append('pret', row.querySelector('input[name="pret"]').value);
            fd.append('ingrediente', row.querySelector('textarea[name="ingrediente"]').value);
            fd.append('alergeni', row.querySelector('textarea[name="alergeni"]').value);



        
            const select = row.cells[7].querySelector('select');
            const catInput = row.cells[7].querySelector('input[name="categorie"]');
            const categorie = select ? select.value : (catInput ? catInput.value : row.cells[7].textContent.trim());
            fd.append('categorie', categorie);
        
            const fileInput = row.querySelector('input[type="file"][name="imagine"]');
            if (fileInput && fileInput.files && fileInput.files[0]) {
              fd.append('imagine', fileInput.files[0]);
            }
            const existingImg = row.dataset.currentImage || '';
        
            try {
              const resp = await fetch(`/admin/update-product/${productId}`, { method: 'POST', body: fd });
              if (!resp.ok) throw new Error('Update failed');
              const data = await resp.json();
              const finalImg = data.image || existingImg || '';
        
              // 🔹 Restaurăm EXACT HTML-ul view inițial al rândului
              const original = row.dataset.viewHtml;
              if (original) row.innerHTML = original;
        
              // 🔹 Acum scriem valorile noi în celulele din view
              // Re-selectăm celulele după restaurare:
              const cells = row.cells;
              cells[1].textContent = fd.get('nume');
              cells[2].textContent = fd.get('descriere');
              cells[3].textContent = fd.get('pret');
              cells[5].textContent = fd.get('ingrediente');
              cells[6].textContent = fd.get('alergeni');
            
              // Imagine: pune exact ce aveai în view (dacă în view afișai text/URL, folosește text; dacă afișai thumbnail, pune img)
              // — Dacă în tabelul tău „view” era text simplu:
              // cells[4].textContent = finalImg ? finalImg : 'None';
        
              // — Dacă vrei thumbnail și în view:
              cells[4].innerHTML = finalImg
                ? `<img src="${finalImg}" alt="Imagine" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #eee">`
                : `<span style="opacity:.6">None</span>`;
            

              // Categorie (span vizibil, select ascuns)
              const span = cells[7].querySelector('span');
              const sel  = cells[7].querySelector('select');
              if (span) span.textContent = categorie;
              if (sel)  sel.value = categorie;
        
              // Asigurăm starea butoanelor
              const editBtn = row.querySelector('.edit-button');
              const saveBtn = row.querySelector('.save-button');
              if (editBtn) editBtn.style.display = 'inline-block';
              if (saveBtn) saveBtn.style.display = 'none';
        
              alert('Produs actualizat cu succes!');
            } catch (err) {
              console.error(err);
              alert('Eroare la actualizarea produsului.');
            }
          }
        });

        </script>
        
        
            <footer>
                <p>&copy; 2025 Dor de Gust. Toate drepturile rezervate.</p>
            </footer>
</body>
</html>
