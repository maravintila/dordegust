<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/ddgsubmark.svg') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editează Produse</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    th, td {
        border: 1px solid var(--caramel);
        padding: 10px;
        text-align: center;
    }
    
    th {
        background-color: var(--roz-glazurat);
        font-family: 'Lato Bold', Arial, sans-serif;
    }
    
    input[type="text"],
    input[type="number"],
    select {
        width: 90%;
        padding: 5px;
        border: 1px solid var(--caramel);
        border-radius: 4px;
        font-family: 'Lato', Arial, sans-serif;
    }
    
    button {
        padding: 5px 10px;
        background-color: var(--inghetata-capsuni);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    button:hover {
        background-color: var(--miere);
    }
    
    .save-button {
        background-color: var(--ciocolata-neagra);
    }
    </style>
</head>
<body>
    <header>
        <h1>Panou Admin</h1>
        <nav>
            <ul>
                <li><a href="/admin">Adauga</a></li>
                <li><a href="/admin/edit-producs">Editeaza</a></li>
                <li><a href="/logout">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h2>Editează Produse</h2>
        <table id="products-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nume</th>
                    <th>Descriere</th>
                    <th>Preț</th>
                    <th>Imagine</th>
                    <th>Ingrediente</th>
                    <th>Categorie</th>
                    <th>Acțiuni</th>
                </tr>
            </thead>
            <tbody>
                {% for produs in produse %}
                <tr data-id="{{ produs['id'] }}">
                    <td>{{ produs['id'] }}</td>
                    <td class="view-mode">{{ produs['nume'] }}</td>
                    <td class="view-mode">{{ produs['descriere'] }}</td>
                    <td class="view-mode">{{ produs['pret'] }}</td>
                    <td class="view-mode">{{ produs['imagine'] }}</td>
                    <td class="view-mode">{{ produs['ingrediente'] }}</td>
                    <td class="view-mode">
                        <select style="display: none;">
                            {% for category in categories %}
                            <option value="{{ category['categorie'] }}" {% if category['categorie'] == produs['categorie'] %}selected{% endif %}>
                                {{ category['categorie'] }}
                            </option>
                            {% endfor %}
                        </select>
                        <span>{{ produs['categorie'] }}</span>
                    </td>
                    <td>
                        <button class="edit-button">Editează</button>
                        <button class="save-button" style="display: none;">Salvează</button>
                    </td>
                </tr>
                
                {% endfor %}
            </tbody>
        </table>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
          const table = document.getElementById('products-table');
        
          table.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const row = btn.closest('tr');
        
            if (btn.classList.contains('edit-button')) {
              enableEditMode(row);
            } else if (btn.classList.contains('save-button')) {
              saveRow(row);
            }
          });
        
          function enableEditMode(row) {
            // coloane: 0 ID | 1 Nume | 2 Descriere | 3 Preț | 4 Imagine | 5 Ingrediente | 6 Categorie | 7 Acțiuni
            // Memorăm imaginea curentă ca fallback
            const imgCell = row.cells[4];
            const currentImg = (imgCell.querySelector('img')?.getAttribute('src')
                                || imgCell.textContent || '').trim();
        
            row.dataset.currentImage = currentImg; // o folosim la salvare dacă nu alegi alt fișier
        
            // Nume
            row.cells[1].innerHTML = `<input type="text" name="nume" value="${row.cells[1].textContent.trim()}">`;
            // Descriere
            row.cells[2].innerHTML = `<input type="text" name="descriere" value="${row.cells[2].textContent.trim()}">`;
            // Preț
            row.cells[3].innerHTML = `<input type="number" step="0.01" name="pret" value="${row.cells[3].textContent.trim()}">`;
        
            // Imagine: thumbnail + input file
            imgCell.innerHTML = `
              <div class="img-edit" style="display:flex;flex-direction:column;align-items:center;gap:8px">
                ${ currentImg
                    ? `<img class="thumb-preview" src="${currentImg}" alt="Previzualizare" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #eee">`
                    : `<div class="thumb-preview" style="width:80px;height:80px;border-radius:6px;border:1px dashed #ccc;display:flex;align-items:center;justify-content:center;font-size:12px;color:#777">Fără</div>`
                }
                <label class="btn-choose" style="background:#ec4e5d;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">
                  Alege imagine
                  <input type="file" name="imagine" accept="image/*" hidden>
                </label>
                <small style="opacity:.7">Dacă nu alegi nimic, rămâne imaginea actuală.</small>
              </div>
            `;
        
            // Ingrediente
            row.cells[5].innerHTML = `<input type="text" name="ingrediente" value="${row.cells[5].textContent.trim()}">`;
        
            // Categorie: arată selectul existent (dacă ai unul acolo) și ascunde span-ul
            const select = row.cells[6].querySelector('select');
            const span = row.cells[6].querySelector('span');
            if (select && span) {
              select.style.display = 'inline-block';
              span.style.display = 'none';
            } else if (!select) {
              // fallback: input text dacă n-ai select
              row.cells[6].innerHTML = `<input type="text" name="categorie" value="${row.cells[6].textContent.trim()}">`;
            }
        
            row.querySelector('.edit-button').style.display = 'none';
            row.querySelector('.save-button').style.display = 'inline-block';
          }
        
          async function saveRow(row) {
            const productId = row.dataset.id;
        
            const fd = new FormData();
            fd.append('nume',        row.querySelector('input[name="nume"]').value);
            fd.append('descriere',   row.querySelector('input[name="descriere"]').value);
            fd.append('pret',        row.querySelector('input[name="pret"]').value);
            fd.append('ingrediente', row.querySelector('input[name="ingrediente"]').value);
        
            // categorie fie din select, fie din input fallback
            const select = row.cells[6].querySelector('select');
            const catInput = row.cells[6].querySelector('input[name="categorie"]');
            const categorie = select ? select.value : (catInput ? catInput.value : row.cells[6].textContent.trim());
            fd.append('categorie', categorie);
        
            // fișier (dacă s-a ales)
            const fileInput = row.querySelector('input[type="file"][name="imagine"]');
            if (fileInput && fileInput.files && fileInput.files[0]) {
              fd.append('imagine', fileInput.files[0]);
            }
        
            // fallback dacă nu alegi fișier
            const existingImg = row.dataset.currentImage || '';
        
            try {
              const resp = await fetch(`/admin/update-product/${productId}`, {
                method: 'POST',
                body: fd
              });
              if (!resp.ok) throw new Error('Update failed');
              const data = await resp.json();
        
              // rescriem celulele cu valori „non-edit”
              row.cells[1].textContent = fd.get('nume');
              row.cells[2].textContent = fd.get('descriere');
              row.cells[3].textContent = fd.get('pret');
        
              // Imagine: folosim URL-ul nou dacă a venit, altfel îl păstrăm pe cel vechi
              const finalImg = data.image || existingImg || '';
              row.cells[4].innerHTML = finalImg
                ? `<img src="${finalImg}" alt="Imagine" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #eee">`
                : `<span style="opacity:.6">None</span>`;
        
              // Categorie
              if (select) {
                row.cells[6].querySelector('span').textContent = categorie;
                row.cells[6].querySelector('span').style.display = 'inline-block';
                select.style.display = 'none';
              } else {
                row.cells[6].textContent = categorie;
              }
        
              row.querySelector('.edit-button').style.display = 'inline-block';
              row.querySelector('.save-button').style.display = 'none';
              alert('Produs actualizat cu succes!');
            } catch (err) {
              console.error(err);
              alert('Eroare la actualizarea produsului.');
            }
          }
        });
        </script>
        
            <footer>
                <p>&copy; 2025 Dor de Gust. Toate drepturile rezervate.</p>
            </footer>
</body>
</html>
