<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/ddgsubmark.svg') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EditeazƒÉ Produse</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    th, td {
        border: 1px solid var(--caramel);
        padding: 10px;
        text-align: center;
    }
    
    th {
        background-color: var(--roz-glazurat);
        font-family: 'Lato Bold', Arial, sans-serif;
    }
    
    input[type="text"],
    input[type="number"],
    select {
        width: 90%;
        padding: 5px;
        border: 1px solid var(--caramel);
        border-radius: 4px;
        font-family: 'Lato', Arial, sans-serif;
    }
    
    button {
        padding: 5px 10px;
        background-color: var(--inghetata-capsuni);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    button:hover {
        background-color: var(--miere);
    }
    
    .save-button {
        background-color: var(--ciocolata-neagra);
    }
    </style>
</head>
<body>
    <header>
        <h1>Panou Admin</h1>
        <nav>
            <ul>
                <li><a href="/admin">Adauga</a></li>
                <li><a href="/admin/edit-producs">Editeaza</a></li>
                <li><a href="/logout">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h2>EditeazƒÉ Produse</h2>
        <table id="products-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nume</th>
                    <th>Descriere</th>
                    <th>Pre»õ</th>
                    <th>Imagine</th>
                    <th>Ingrediente</th>
                    <th>Categorie</th>
                    <th>Ac»õiuni</th>
                </tr>
            </thead>
            <tbody>
                {% for produs in produse %}
                <tr data-id="{{ produs['id'] }}">
                    <td>{{ produs['id'] }}</td>
                    <td class="view-mode">{{ produs['nume'] }}</td>
                    <td class="view-mode">{{ produs['descriere'] }}</td>
                    <td class="view-mode">{{ produs['pret'] }}</td>
                    <td class="view-mode">{{ produs['imagine'] }}</td>
                    <td class="view-mode">{{ produs['ingrediente'] }}</td>
                    <td class="view-mode">
                        <select style="display: none;">
                            {% for category in categories %}
                            <option value="{{ category['categorie'] }}" {% if category['categorie'] == produs['categorie'] %}selected{% endif %}>
                                {{ category['categorie'] }}
                            </option>
                            {% endfor %}
                        </select>
                        <span>{{ produs['categorie'] }}</span>
                    </td>
                    <td>
                        <button class="edit-button">EditeazƒÉ</button>
                        <button class="save-button" style="display: none;">SalveazƒÉ</button>
                    </td>
                </tr>
                
                {% endfor %}
            </tbody>
        </table>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
          const table = document.getElementById('products-table');
        
          table.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const row = btn.closest('tr');
            if (btn.classList.contains('edit-button')) enableEditMode(row);
            if (btn.classList.contains('save-button')) saveRow(row);
          });
        
          function enableEditMode(row) {
            // üîπ SalvƒÉm HTML-ul original ca sƒÉ putem reveni exact la view.
            row.dataset.viewHtml = row.innerHTML;
        
            // coloane: 0 ID | 1 Nume | 2 Descriere | 3 Pre»õ | 4 Imagine | 5 Ingrediente | 6 Categorie | 7 Ac»õiuni
            const imgCell = row.cells[4];
            const currentImg =
              imgCell.querySelector('img')?.getAttribute('src') ||
              imgCell.textContent.trim();
        
            row.dataset.currentImage = currentImg;
        
            row.cells[1].innerHTML = `<input type="text" name="nume" value="${row.cells[1].textContent.trim()}">`;
            row.cells[2].innerHTML = `<input type="text" name="descriere" value="${row.cells[2].textContent.trim()}">`;
            row.cells[3].innerHTML = `<input type="number" step="0.01" name="pret" value="${row.cells[3].textContent.trim()}">`;
        
            imgCell.innerHTML = `
              <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
                ${ currentImg
                    ? `<img class="thumb-preview" src="${currentImg}" alt="Previzualizare" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #eee">`
                    : `<div class="thumb-preview" style="width:80px;height:80px;border:1px dashed #ccc;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#777">FƒÉrƒÉ</div>`
                }
                <label style="background:#ec4e5d;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">
                  Alege imagine
                  <input type="file" name="imagine" accept="image/*" hidden>
                </label>
                <small style="opacity:.7">DacƒÉ nu alegi nimic, rƒÉm√¢ne imaginea actualƒÉ.</small>
              </div>
            `;
        
            row.cells[5].innerHTML = `<input type="text" name="ingrediente" value="${row.cells[5].textContent.trim()}">`;
        
            const select = row.cells[6].querySelector('select');
            const span = row.cells[6].querySelector('span');
            if (select && span) { select.style.display = 'inline-block'; span.style.display = 'none'; }
            else if (!select) { row.cells[6].innerHTML = `<input type="text" name="categorie" value="${row.cells[6].textContent.trim()}">`; }
        
            row.querySelector('.edit-button').style.display = 'none';
            row.querySelector('.save-button').style.display = 'inline-block';
          }
        
          async function saveRow(row) {
            const productId = row.dataset.id;
        
            const fd = new FormData();
            fd.append('nume',        row.querySelector('input[name="nume"]').value);
            fd.append('descriere',   row.querySelector('input[name="descriere"]').value);
            fd.append('pret',        row.querySelector('input[name="pret"]').value);
            fd.append('ingrediente', row.querySelector('input[name="ingrediente"]').value);
        
            const select = row.cells[6].querySelector('select');
            const catInput = row.cells[6].querySelector('input[name="categorie"]');
            const categorie = select ? select.value : (catInput ? catInput.value : row.cells[6].textContent.trim());
            fd.append('categorie', categorie);
        
            const fileInput = row.querySelector('input[type="file"][name="imagine"]');
            if (fileInput && fileInput.files && fileInput.files[0]) {
              fd.append('imagine', fileInput.files[0]);
            }
            const existingImg = row.dataset.currentImage || '';
        
            try {
              const resp = await fetch(`/admin/update-product/${productId}`, { method: 'POST', body: fd });
              if (!resp.ok) throw new Error('Update failed');
              const data = await resp.json();
              const finalImg = data.image || existingImg || '';
        
              // üîπ RestaurƒÉm EXACT HTML-ul view ini»õial al r√¢ndului
              const original = row.dataset.viewHtml;
              if (original) row.innerHTML = original;
        
              // üîπ Acum scriem valorile noi √Æn celulele din view
              // Re-selectƒÉm celulele dupƒÉ restaurare:
              const cells = row.cells;
              cells[1].textContent = fd.get('nume');
              cells[2].textContent = fd.get('descriere');
              cells[3].textContent = fd.get('pret');
        
              // Imagine: pune exact ce aveai √Æn view (dacƒÉ √Æn view afi»ôai text/URL, folose»ôte text; dacƒÉ afi»ôai thumbnail, pune img)
              // ‚Äî DacƒÉ √Æn tabelul tƒÉu ‚Äûview‚Äù era text simplu:
              // cells[4].textContent = finalImg ? finalImg : 'None';
        
              // ‚Äî DacƒÉ vrei thumbnail »ôi √Æn view:
              cells[4].innerHTML = finalImg
                ? `<img src="${finalImg}" alt="Imagine" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #eee">`
                : `<span style="opacity:.6">None</span>`;
        
              // Categorie (span vizibil, select ascuns)
              const span = cells[6].querySelector('span');
              const sel  = cells[6].querySelector('select');
              if (span) span.textContent = categorie;
              if (sel)  sel.value = categorie;
        
              // AsigurƒÉm starea butoanelor
              const editBtn = row.querySelector('.edit-button');
              const saveBtn = row.querySelector('.save-button');
              if (editBtn) editBtn.style.display = 'inline-block';
              if (saveBtn) saveBtn.style.display = 'none';
        
              alert('Produs actualizat cu succes!');
            } catch (err) {
              console.error(err);
              alert('Eroare la actualizarea produsului.');
            }
          }
        });
        </script>
        
        
            <footer>
                <p>&copy; 2025 Dor de Gust. Toate drepturile rezervate.</p>
            </footer>
</body>
</html>
